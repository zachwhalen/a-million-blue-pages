<html>
<head>
	<link rel="icon" type="image/ico" href="favicon.ico"/>
	<title>Latest - A Million Blue Pages</title>
<!--#include virtual="inc/head.html"-->
<!-- this page should show the latest however-many posts on AMBP. 
     reverse-chronologically.
	 
	 -->
	 <script type="text/javascript">
	 
		offset = 0;
		if (getURLParameter('o') != 'null'){
			offset = getURLParameter('o');
			
		}
		$(document).ready( function () {
			template = Handlebars.compile($("#latest-template").html());
			$('#null').sheetrock({
					url: 'https://docs.google.com/spreadsheet/ccc?key=0AjzKgFlHsxs_dEhQVENrb1I2SllPa19ZSjVtMWtNVEE&usp=drive_web#gid=0',
					sql: 'select A,B,C,D,F,G,H,I,K,L,N where P != "skip" order by N desc limit 30 offset ' + offset, 

					headersOff: true,
					rowHandler : latestRows,
					userCallBack : keepDoingStuff
			});
			
			if (offset - 30 > 0){
				$("#browse .previous").html("<a href='/latest.shtml?o="+ (offset - 30) + "'>&laquo;  Previous 30</a>");
			}
			$("#browse .next").html("<a href='/latest.shtml?o=" + (offset * 1 + 30) + "'>Next 30 &raquo;</a>");
			
			
		});
		
		function latestRows(data){
			console.log(data);
			var author = '';
			var title = '';
			if (data.cells.data){
				apid = $.parseJSON(data.cells.data) ? $.parseJSON(data.cells.data) : '';
				
				if (data.cells.source == 'tumblr'){
					author = apid.post_author ? apid.post_author : apid.blog_name;
				}else{
					author = data.cells.username;
				}
				title = apid.title ? apid.title : '';
				
					
				
			}else{
				author = data.cells.username;
			}
			var sourceMsg = '';
			if (data.cells.source == 'twitter'){
				sourceMsg = '';
				img = '';
			}else{
				sourceMsg = ' on ' + data.cells.source;	
			}
			
			if (data.cells.type == 'video'){
				img = data.cells.thumbnail;
			}else{
				img = data.cells.larger;
			}
			
			var tags = data.cells.tags.replace(/hol14,/ig,'').replace(/,/g,', ');
			var when = (data.cells.timestamp == "") ? data.cells.digested : data.cells.timestamp;
			
			var h = {
				'type' : data.cells.type,
				'source' : data.cells.source,
				'img' : img,
				'tags' : tags,
				'author' : author,
				'sourceMsg' : sourceMsg,
				'typePre' : ($.inArray(data.cells.type, ['text','audio']) == -1) ? ' a ' : '',
				'title' : title,
				'link' : data.cells.link,
				'page' : data.cells.page,
				'when' : $.timeago(sanitizeTime(when))
			};
			
			$("#latest").append(template(h));
		}
		
		function keepDoingStuff (){
			
		}
	 </script>
	
</head>
<body>
<div class="wrapper">
<!--#include virtual="inc/header.html"-->
<div id="latest">

</div>
<div id="null">

</div>
<div id="browse">
	<span class="previous">&laquo; Previous 30</span> &nbsp;&nbsp;||&nbsp;&nbsp; <span class="next">Next 30 &raquo;</span>
</div>
<!--#include virtual="inc/footer.html"-->
<script id="latest-template" type="text/x-handlebars-template">

	<div class="lt-node {{type}} {{source}}">
		<div class="lt-type-frame">
		<div class="lt-image" style="background-image: url({{img}}); background-size: cover">
			<div class="source-legend"> </div>
			<div class="type-legend"> </div>

		</div>	
		</div>
		<div class="lt-info">
			<div class="lt-message">
				{{author}} shared <span class="lt-type">{{typePre}}<a href="{{link}}">{{type}}</a></a>
				{{#if title}}
				, "{{title}},"
				{{/if}}
				 for <span class="lt-page"><a href="/page.shtml?page={{page}}">page {{page}}</a></span>{{sourceMsg}}.
			</div>
		    <div class="lt-when">
		    	{{when}}
		    </div>
			<div class="lt-tags">
				Tags: {{tags}}
			</div>
			<div class="lt-actions">
				
				<a href="/page.shtml?page={{page}}">Context</a>
				<a href="{{link}}">Link</a>  
			</div>	
		</div>
		<br style="clear:both" />
	</div>
</script>
</body>